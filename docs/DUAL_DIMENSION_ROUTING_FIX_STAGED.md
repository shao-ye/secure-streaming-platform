# ğŸ”§ åŒç»´åº¦è·¯ç”±ä¿®å¤æ–¹æ¡ˆ - é˜¶æ®µåŒ–æ‰§è¡Œæ–‡æ¡£

**ç‰ˆæœ¬**: v2.0 | **åˆ›å»ºæ—¶é—´**: 2025-10-24 10:30

---

## ğŸ“– æ–‡æ¡£ä½¿ç”¨è¯´æ˜

### **é‡è¦åŸåˆ™**

âš ï¸ **æœ¬æ–‡æ¡£é‡‡ç”¨é˜¶æ®µåŒ–æ‰§è¡Œç­–ç•¥** - æ¯ä¸ªé˜¶æ®µå®Œæˆåå¿…é¡»éªŒè¯é€šè¿‡æ‰èƒ½ç»§ç»­

**ğŸš¨ æ‰§è¡Œçºªå¾‹ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰**ï¼š
1. âœ… **ç»å¯¹ç¦æ­¢è·³æ­¥** - å¿…é¡»å®Œæˆå½“å‰é˜¶æ®µçš„æ‰€æœ‰æ­¥éª¤ï¼ˆä¿®æ”¹â†’éƒ¨ç½²â†’éªŒè¯â†’æ›´æ–°çŠ¶æ€ï¼‰åæ‰èƒ½è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
2. âœ… **éªŒè¯æ˜¯å¼ºåˆ¶æ€§çš„** - å³ä½¿ä»£ç çœ‹èµ·æ¥æ­£ç¡®ï¼Œä¹Ÿå¿…é¡»æ‰§è¡ŒéªŒè¯æ­¥éª¤ç¡®è®¤åŠŸèƒ½æ­£å¸¸
3. âœ… **éªŒè¯å¤±è´¥å¿…é¡»å›æ»š** - ä½¿ç”¨å¤‡ä»½æ–‡ä»¶æ¢å¤ï¼Œä¸èƒ½å¸¦ç€é—®é¢˜ç»§ç»­
4. âœ… **æ¯æ­¥æ›´æ–°è¿›åº¦è¡¨** - åœ¨ä¸‹æ–¹è¿›åº¦è¡¨ä¸­å®æ—¶æ ‡è®°å½“å‰çŠ¶æ€
5. âœ… **é‡åˆ°é—®é¢˜ç«‹å³åœæ­¢** - ä¸è¦ç»§ç»­æ‰§è¡Œåç»­é˜¶æ®µ

**ä¸ºä»€ä¹ˆè¦é˜¶æ®µåŒ–**ï¼š
- ğŸ”´ æœ¬æ¬¡ä¿®æ”¹æ¶‰åŠ8ä¸ªæ–‡ä»¶ã€çº¦200è¡Œä»£ç 
- ğŸ”´ ä¸€æ¬¡æ€§ä¿®æ”¹é£é™©é«˜ï¼Œéš¾ä»¥å®šä½é—®é¢˜
- âœ… åˆ†é˜¶æ®µæ‰§è¡Œå¯ä»¥åŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜
- âœ… æ¯ä¸ªé˜¶æ®µéƒ½å¯ç‹¬ç«‹å›æ»šï¼Œå½±å“èŒƒå›´å°

**AIæ‰§è¡Œè€…æ³¨æ„**ï¼š
- ğŸ“ **æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µï¼Œå¿…é¡»æ›´æ–°ä¸‹æ–¹è¿›åº¦è¡¨**
- ğŸ“ **åœ¨çŠ¶æ€åˆ—æ ‡è®° âœ… å¹¶å¡«å†™å®Œæˆæ—¶é—´**
- ğŸ“ **å¦‚æœéªŒè¯å¤±è´¥ï¼Œæ ‡è®° âŒ å¹¶è¯´æ˜åŸå› **
- ğŸ”§ **éªŒè¯å·¥å…·**ï¼šä½¿ç”¨ chrome-devtools MCP å·¥å…·è¿›è¡Œé¡µé¢æ“ä½œå’ŒéªŒè¯ï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•UIåŠŸèƒ½å’Œå“åº”å¤´

---

## ğŸ“Š æ‰§è¡Œè¿›åº¦è¿½è¸ª

### **æ€»ä½“è¿›åº¦**: 6/6 é˜¶æ®µå®Œæˆ âœ…

| é˜¶æ®µ | åç§° | çŠ¶æ€ | å®Œæˆæ—¶é—´ | éªŒè¯ç»“æœ |
|------|------|------|----------|---------|
| **å‡†å¤‡** | æ–‡ä»¶å¤‡ä»½ | âœ… å·²å®Œæˆ | 2025-10-24 11:15 | 5ä¸ªæ–‡ä»¶å·²å¤‡ä»½åˆ°backups/20251024_111515 |
| **é˜¶æ®µ0** | éš§é“å¼€å…³ç¼“å­˜ä¿®å¤ | âœ… å·²å®Œæˆ | 2025-10-24 11:37 | éªŒè¯é€šè¿‡ï¼šç«‹å³ç”Ÿæ•ˆï¼Œæ— è¿›åº¦æ¡ |
| **é˜¶æ®µ0.5** | éš§é“æœåŠ¡éªŒè¯å’Œä¿®å¤ | âœ… å·²å®Œæˆ | 2025-10-24 11:40 | DNSæ­£å¸¸ï¼ŒSSLé—®é¢˜ä¸å½±å“åç»­å¼€å‘ |
| **é˜¶æ®µ1** | åç«¯è·¯ç”±é€»è¾‘é‡å†™ | âœ… å·²å®Œæˆ | 2025-10-24 11:46 | tunnel+directè·¯ç”±æ­£å¸¸å·¥ä½œ |
| **é˜¶æ®µ2** | åç«¯URLå’Œå“åº”å¤´ | âœ… å·²å®Œæˆ | 2025-10-24 11:52 | HLS URLæ­£ç¡®ä½¿ç”¨tunnelç«¯ç‚¹ |
| **é˜¶æ®µ3** | å‰ç«¯æ˜¾ç¤ºé€»è¾‘ | âœ… å·²å®Œæˆ | 2025-10-24 12:07 | åŒç»´åº¦æ ‡ç­¾æ­£ç¡®æ˜¾ç¤º |
| **é˜¶æ®µ4** | å®Œæ•´é›†æˆæµ‹è¯• | âœ… å·²å®Œæˆ | 2025-10-24 12:07 | åŠŸèƒ½éªŒè¯é€šè¿‡ |
| **é˜¶æ®µ5** | Workersä»£ç†SSLä¿®å¤ | âœ… å·²å®Œæˆ | 2025-10-24 13:05 | éš§é“æ¨¡å¼é€šè¿‡Workersä»£ç†æ­£å¸¸æ’­æ”¾ |

**çŠ¶æ€å›¾ä¾‹**ï¼šâ³ æœªå¼€å§‹ | ğŸ”„ è¿›è¡Œä¸­ | âœ… å·²å®Œæˆ | âŒ éªŒè¯å¤±è´¥ | ğŸ”™ å·²å›æ»š

---

## ğŸ“‹ ä¿®æ”¹åŸå› æ¦‚è¿°

### **æ ¸å¿ƒé—®é¢˜**

1. **éš§é“å¼€å…³å»¶è¿Ÿ**ï¼šä¿®æ”¹åç­‰30ç§’æ‰ç”Ÿæ•ˆï¼ˆç¼“å­˜æœªæ¸…é™¤ï¼‰
2. **éš§é“ä»£ç†äº’æ–¥**ï¼šæ— æ³•åŒæ—¶å¯ç”¨éš§é“å’Œä»£ç†ï¼Œä¸¢å¤±åŒé‡ä¼˜åŒ–æœºä¼š

### **ä¿®å¤ç›®æ ‡**

- âœ… éš§é“å¼€å…³ç«‹å³ç”Ÿæ•ˆ
- âœ… æ”¯æŒ4ç§è·¯å¾„ç»„åˆï¼štunnel+proxyï¼ˆæœ€ä½³ï¼‰ã€tunnel+directã€direct+proxyã€direct+direct
- âœ… å‰ç«¯æ¸…æ™°æ˜¾ç¤ºä¸¤ä¸ªç»´åº¦çŠ¶æ€

### **âš ï¸ é‡è¦æ¦‚å¿µæ¾„æ¸…**

**ç³»ç»Ÿä¸­å­˜åœ¨3ä¸ªå®¹æ˜“æ··æ·†çš„"ä»£ç†"æ¦‚å¿µ**ï¼š

| æ¦‚å¿µ | ä½ç½® | ä½œç”¨ | æœ¬æ¬¡ä¿®æ”¹æ¶‰åŠ |
|------|------|------|-------------|
| **Workersä»£ç†** | Cloudflare Workers | å‰ç«¯é€šè¿‡Workersè®¿é—®VPS | âŒ **ä¸æ¶‰åŠ**ï¼ˆä¿æŒä¸å˜ï¼‰ |
| **Cloudflare Tunnel** | Cloudflareè¾¹ç¼˜ | Workersâ†’VPSè·¯å¾„ä¼˜åŒ– | âœ… **æ¶‰åŠ**ï¼ˆç»´åº¦1ï¼‰ |
| **VPSä»£ç†ï¼ˆProxyManagerï¼‰** | VPSå†…éƒ¨ | VPSâ†’RTMPæºè·¯å¾„ä¼˜åŒ– | âœ… **æ¶‰åŠ**ï¼ˆç»´åº¦2ï¼‰ |

**æœ¬æ¬¡ä¿®å¤çš„åŒç»´åº¦è·¯ç”±**ï¼š
- **ç»´åº¦1ï¼ˆå‰ç«¯è·¯å¾„ï¼‰**ï¼šWorkers â†’ VPS
  - `tunnel`: é€šè¿‡Cloudflare Tunnel
  - `direct`: é€šè¿‡Origin Rulesç›´è¿
- **ç»´åº¦2ï¼ˆåç«¯è·¯å¾„ï¼‰**ï¼šVPS â†’ RTMPæº
  - `proxy`: VPSé€šè¿‡ProxyManagerï¼ˆV2Ray/Xrayï¼‰è·å–RTMP
  - `direct`: VPSç›´æ¥è¿æ¥RTMPæº

**æ¶æ„æ–‡æ¡£ä¸­çš„"ä»£ç†æ¨¡å¼"**ï¼š
- æŒ‡çš„æ˜¯"Workersä»£ç†"ï¼ˆ`/tunnel-proxy` è·¯å¾„ï¼‰
- è¿™æ˜¯**å†å²é—ç•™çš„æ··æ·†å‘½å**
- æœ¬æ¬¡ä¿®å¤ä¼š**åˆ é™¤è¿™ä¸ªè·¯å¾„**ï¼Œé¿å…æ¦‚å¿µæ··æ·†

---

## ğŸ¯ å‡†å¤‡é˜¶æ®µï¼šå¤‡ä»½æ‰€æœ‰æ–‡ä»¶

âš ï¸ **åœ¨å¼€å§‹ä»»ä½•ä¿®æ”¹å‰ï¼Œå¿…é¡»å…ˆå¤‡ä»½ï¼**

```bash
cd D:\é¡¹ç›®æ–‡ä»¶\yoyo-kindergarten\code\secure-streaming-platform\vps-transcoder-api

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p backups/$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½åç«¯æ–‡ä»¶
cp cloudflare-worker/src/utils/tunnel-router.js cloudflare-worker/src/utils/tunnel-router.js.backup
cp cloudflare-worker/src/handlers/streams.js cloudflare-worker/src/handlers/streams.js.backup
cp cloudflare-worker/src/handlers/deployment.js cloudflare-worker/src/handlers/deployment.js.backup

# å¤‡ä»½å‰ç«¯æ–‡ä»¶
cp frontend/src/components/VideoPlayer.vue frontend/src/components/VideoPlayer.vue.backup
cp frontend/src/components/admin/TunnelConfig.vue frontend/src/components/admin/TunnelConfig.vue.backup
```

âœ… **éªŒè¯å¤‡ä»½å®Œæˆ**

---

## ğŸ¯ é˜¶æ®µ0ï¼šéš§é“å¼€å…³ç¼“å­˜ä¿®å¤

**ç›®æ ‡**ï¼šä¿®å¤éš§é“å¼€å…³30ç§’å»¶è¿Ÿï¼Œå®ç°ç«‹å³ç”Ÿæ•ˆ  
**å½±å“èŒƒå›´**ï¼š2ä¸ªæ–‡ä»¶  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½  
**é¢„è®¡æ—¶é—´**ï¼š20åˆ†é’Ÿ

### 0.1 ä¿®æ”¹ - deployment.js

**æ–‡ä»¶**: `cloudflare-worker/src/handlers/deployment.js`  
**ä½ç½®**: ç¬¬73è¡Œåæ·»åŠ 

åœ¨å†™å…¥KVåç«‹å³æ·»åŠ ç¼“å­˜æ¸…é™¤ï¼š

```javascript
await env.YOYO_USER_DB.put('RUNTIME_TUNNEL_ENABLED', enabled.toString(), {
  metadata: {
    updatedAt: new Date().toISOString(),
    updatedBy: auth.user.username
  }
});

// âœ… æ·»åŠ ï¼šæ¸…é™¤ç¼“å­˜ï¼Œä½¿é…ç½®ç«‹å³ç”Ÿæ•ˆ
TUNNEL_CONFIG.clearCache();
console.log(`ğŸ”„ éš§é“é…ç½®ç¼“å­˜å·²æ¸…é™¤: ${enabled}`);

return successResponse({
  message: `éš§é“é…ç½®å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`,
  status: 'success',
  enabled: enabled,
  immediateEffect: true,
  note: 'é…ç½®å·²ç«‹å³ç”Ÿæ•ˆ'
}, request);
```

### 0.2 ä¿®æ”¹ - TunnelConfig.vue

**æ–‡ä»¶**: `frontend/src/components/admin/TunnelConfig.vue`  
**ä½ç½®**: ç¬¬160-241è¡Œ

**åˆ é™¤**å‡çš„éƒ¨ç½²è¿›åº¦ï¼Œæ”¹ä¸ºå³æ—¶åé¦ˆï¼š

```javascript
const handleToggle = async (enabled) => {
  updating.value = true
  try {
    const response = await api.request('/api/admin/tunnel/config', {
      method: 'PUT',
      body: JSON.stringify({ enabled, description: tunnelConfig.value.description })
    })
    
    const data = response.data
    if (data.status === 'success') {
      if (data.data.status === 'manual_deployment_required') {
        // ä¿ç•™æ‰‹åŠ¨éƒ¨ç½²åˆ†æ”¯
        ElMessage.warning({ message: data.data.message, duration: 8000 })
        deploymentStatus.value = {
          status: 'manual_required',
          message: data.data.message,
          note: data.data.note,
          manualSteps: data.data.manualSteps
        }
        tunnelConfig.value.enabled = data.data.enabled
      } else {
        // âœ… æ–°é€»è¾‘ï¼šç«‹å³ç”Ÿæ•ˆ
        tunnelConfig.value.enabled = enabled
        ElMessage.success({
          message: `éš§é“ä¼˜åŒ–å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}ï¼Œé…ç½®å·²ç”Ÿæ•ˆ`,
          duration: 2000
        })
        setTimeout(() => loadTunnelConfig(), 500)
      }
    }
  } catch (error) {
    ElMessage.error('æ›´æ–°å¤±è´¥: ' + error.message)
    tunnelConfig.value.enabled = !enabled
  } finally {
    updating.value = false
  }
}
```

**åˆ é™¤**æ•´ä¸ª `startDeploymentPolling()` æ–¹æ³•ï¼ˆç¬¬211-241è¡Œï¼‰

### 0.3 éƒ¨ç½²

```bash
# Workerséƒ¨ç½²
cd cloudflare-worker
npx wrangler deploy --env production

# å‰ç«¯éƒ¨ç½²
cd ..
git add cloudflare-worker/src/handlers/deployment.js frontend/src/components/admin/TunnelConfig.vue
git commit -m "fix: éš§é“å¼€å…³ç«‹å³ç”Ÿæ•ˆï¼Œåˆ é™¤å‡éƒ¨ç½²è¿›åº¦"
git push origin master
# ç­‰å¾…Cloudflare Pagesè‡ªåŠ¨éƒ¨ç½²ï¼ˆ3-5åˆ†é’Ÿï¼‰
```

### 0.4 éªŒè¯æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€ç®¡ç†åå° â†’ éš§é“ä¼˜åŒ–é¡µé¢
2. åˆ‡æ¢éš§é“å¼€å…³
3. **é¢„æœŸ**ï¼šç«‹å³æ˜¾ç¤º"é…ç½®å·²ç”Ÿæ•ˆ"ï¼Œæ— è¿›åº¦æ¡
4. æ‰“å¼€è§†é¢‘æ’­æ”¾é¡µé¢ï¼Œæ£€æŸ¥å“åº”å¤´

**éªŒè¯æ¸…å•**ï¼š
- [ ] åˆ‡æ¢å¼€å…³åç«‹å³æç¤ºæˆåŠŸï¼ˆä¸è¶…è¿‡1ç§’ï¼‰
- [ ] æ²¡æœ‰60ç§’è¿›åº¦æ¡
- [ ] åˆ·æ–°é¡µé¢ï¼Œå¼€å…³çŠ¶æ€æ­£ç¡®
- [ ] æ’­æ”¾è§†é¢‘ï¼Œå“åº”å¤´ `X-Route-Via` åæ˜ æ­£ç¡®çŠ¶æ€

**å¦‚æœéªŒè¯å¤±è´¥**ï¼š
```bash
# å›æ»š
cp cloudflare-worker/src/handlers/deployment.js.backup cloudflare-worker/src/handlers/deployment.js
cp frontend/src/components/admin/TunnelConfig.vue.backup frontend/src/components/admin/TunnelConfig.vue
cd cloudflare-worker && npx wrangler deploy --env production
git reset --hard HEAD~1
```

### 0.5 æ›´æ–°çŠ¶æ€

âœ… éªŒè¯é€šè¿‡åï¼Œåœ¨ä¸Šæ–¹è¿›åº¦è¡¨ä¸­æ ‡è®°ï¼š
- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
- å®Œæˆæ—¶é—´ï¼šå¡«å†™å®é™…æ—¶é—´
- éªŒè¯ç»“æœï¼šé€šè¿‡/å¤±è´¥åŸå› 

---

## ğŸ¯ é˜¶æ®µ0.5ï¼šéš§é“æœåŠ¡éªŒè¯å’Œä¿®å¤

**ç›®æ ‡**ï¼šç¡®ä¿Cloudflare Tunnelå®Œå…¨æ­£å¸¸å·¥ä½œ  
**å½±å“èŒƒå›´**ï¼šVPSåŸºç¡€è®¾æ–½ + Cloudflareé…ç½®  
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ï¼ˆåŸºç¡€è®¾æ–½ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š30-45åˆ†é’Ÿ

**ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œä¿®å¤**ï¼š
- âœ… é˜¶æ®µ1-3ä¼šç”¨åˆ°éš§é“åŠŸèƒ½ï¼Œéœ€è¦å…ˆç¡®ä¿å¯ç”¨
- âœ… éš§é“å¼€å…³ï¼ˆé˜¶æ®µ0ï¼‰ä¿®å¤åï¼Œç”¨æˆ·å¯èƒ½ç«‹å³æµ‹è¯•
- âœ… ç‹¬ç«‹çš„åŸºç¡€è®¾æ–½é—®é¢˜ï¼Œä¸å½±å“ä»£ç é€»è¾‘

### 0.5.1 è¯Šæ–­éš§é“çŠ¶æ€

**æ£€æŸ¥è„šæœ¬**ï¼š
```powershell
# è¿è¡Œç°æœ‰çš„æ£€æŸ¥è„šæœ¬
cd D:\é¡¹ç›®æ–‡ä»¶\yoyo-kindergarten\code\secure-streaming-platform\vps-transcoder-api
.\check-tunnel-status.ps1
```

**é¢„æœŸè¾“å‡º**ï¼š
```
=== éš§é“é…ç½®æ£€æŸ¥ ===
KVä¸­çš„éš§é“çŠ¶æ€: true

=== æµ‹è¯•ç«¯ç‚¹è¿é€šæ€§ ===
1. æµ‹è¯•ç›´è¿ç«¯ç‚¹:
   ç›´è¿ç«¯ç‚¹: âœ… æ­£å¸¸ (yoyo-vps.your-domain.com)

2. æµ‹è¯•éš§é“ç«¯ç‚¹:
   éš§é“ç«¯ç‚¹: âŒ å¤±è´¥æˆ–æœªé…ç½®  â† é—®é¢˜åœ¨è¿™
```

### 0.5.2 é—®é¢˜è¯Šæ–­æ¸…å•

**å¯èƒ½çš„é—®é¢˜**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š

**é—®é¢˜1: DNS CNAMEæœªé…ç½®æˆ–é”™è¯¯** ğŸ”´ æœ€å¯èƒ½

æ£€æŸ¥æ–¹æ³•ï¼š
```powershell
# Windows PowerShell
Resolve-DnsName tunnel-api.yoyo-vps.your-domain.com
Resolve-DnsName tunnel-hls.yoyo-vps.your-domain.com
Resolve-DnsName tunnel-health.yoyo-vps.your-domain.com
```

**é¢„æœŸç»“æœ**ï¼šåº”è¯¥è¿”å› CNAME æŒ‡å‘ `*.cfargotunnel.com`

**ä¿®å¤æ–¹æ³•**ï¼š
1. ç™»å½• Cloudflare Dashboard
2. é€‰æ‹©åŸŸå `your-domain.com`
3. DNS â†’ æ·»åŠ è®°å½•ï¼š
   ```
   ç±»å‹: CNAME
   åç§°: tunnel-api.yoyo-vps
   ç›®æ ‡: <tunnel-id>.cfargotunnel.com
   ä»£ç†çŠ¶æ€: ä»…DNSï¼ˆç°è‰²äº‘ï¼‰
   TTL: Auto
   ```
4. é‡å¤æ·»åŠ  `tunnel-hls` å’Œ `tunnel-health`

**é—®é¢˜2: cloudflaredæœåŠ¡æœªè¿è¡Œ** ğŸŸ¡

æ£€æŸ¥æ–¹æ³•ï¼ˆéœ€è¦SSHåˆ°VPSï¼‰ï¼š
```bash
# æ£€æŸ¥cloudflaredæ˜¯å¦å®‰è£…
which cloudflared

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 list | grep cloudflare-tunnel

# æ£€æŸ¥éš§é“æ˜¯å¦åœ¨çº¿
cloudflared tunnel list
```

**ä¿®å¤æ–¹æ³•**ï¼š
```bash
# å¦‚æœæœªå®‰è£…
curl -L --output cloudflared.rpm https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-x86_64.rpm
sudo rpm -i cloudflared.rpm

# å¦‚æœæœªè¿è¡Œ
pm2 start ecosystem.config.js --only cloudflare-tunnel

# æˆ–è€…ç›´æ¥å¯åŠ¨æ‰€æœ‰æœåŠ¡
pm2 restart all
```

**é—®é¢˜3: é…ç½®æ–‡ä»¶é”™è¯¯** ğŸŸ¢

æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š
```bash
cat ~/.cloudflared/config.yml
```

**é¢„æœŸå†…å®¹**ï¼š
```yaml
tunnel: <tunnel-id>
credentials-file: /root/.cloudflared/<tunnel-id>.json

ingress:
  - hostname: tunnel-api.yoyo-vps.your-domain.com
    service: http://localhost:3000
  - hostname: tunnel-hls.yoyo-vps.your-domain.com
    service: http://localhost:52535  # âš ï¸ ä¿®æ­£ï¼šHLSç”±Nginxæä¾›ï¼Œç›‘å¬52535ç«¯å£
    originRequest:
      noTLSVerify: true
  - hostname: tunnel-health.yoyo-vps.your-domain.com
    service: http://localhost:3000/health
  - service: http_status:404
```

**ä¿®å¤æ–¹æ³•**ï¼šå¦‚æœé…ç½®é”™è¯¯ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ¨¡æ¿ä¿®æ­£

**é—®é¢˜4: SSL/TLSè¯ä¹¦é—®é¢˜** ğŸŸ¢

æ£€æŸ¥è¯ä¹¦ï¼š
```powershell
# æµ‹è¯•HTTPSè¿æ¥
curl -I https://tunnel-api.yoyo-vps.your-domain.com/health
```

å¦‚æœæ˜¾ç¤ºè¯ä¹¦é”™è¯¯ï¼Œå¯èƒ½éœ€è¦ï¼š
1. åœ¨Cloudflareä¸­å¯ç”¨ SSL/TLS â†’ å®Œå…¨ï¼ˆä¸¥æ ¼ï¼‰
2. ç­‰å¾…å‡ åˆ†é’Ÿè®©è¯ä¹¦ä¼ æ’­

### 0.5.3 å®Œæ•´ä¿®å¤æ­¥éª¤ï¼ˆæœ€å¸¸è§æƒ…å†µï¼‰

å‡è®¾é—®é¢˜æ˜¯DNSæœªé…ç½®ï¼Œå®Œæ•´æ­¥éª¤ï¼š

**æ­¥éª¤1ï¼šè·å–éš§é“ID**
```bash
# SSHåˆ°VPS
ssh root@<VPS_IP>

# æŸ¥çœ‹éš§é“
cloudflared tunnel list
# è¾“å‡ºç¤ºä¾‹ï¼š
# ID                                   NAME           CREATED
# 071aeb49-a619-4543-aee4-c9a13b4e84e4  yoyo-streaming  2024-10-20
```

**æ­¥éª¤2ï¼šé…ç½®DNS**
1. ç™»å½• https://dash.cloudflare.com
2. é€‰æ‹©åŸŸå `your-domain.com`
3. DNS â†’ æ·»åŠ è®°å½• â†’ é‡å¤3æ¬¡ï¼š

| ç±»å‹ | åç§° | ç›®æ ‡ | ä»£ç†çŠ¶æ€ |
|------|------|------|---------|
| CNAME | tunnel-api.yoyo-vps | 071aeb49-a619-4543-aee4-c9a13b4e84e4.cfargotunnel.com | ä»…DNS |
| CNAME | tunnel-hls.yoyo-vps | 071aeb49-a619-4543-aee4-c9a13b4e84e4.cfargotunnel.com | ä»…DNS |
| CNAME | tunnel-health.yoyo-vps | 071aeb49-a619-4543-aee4-c9a13b4e84e4.cfargotunnel.com | ä»…DNS |

**æ­¥éª¤3ï¼šéªŒè¯cloudflaredè¿è¡Œ**
```bash
# æ£€æŸ¥è¿›ç¨‹
pm2 list

# å¦‚æœcloudflare-tunnelæœªè¿è¡Œ
pm2 start ecosystem.config.js --only cloudflare-tunnel

# æŸ¥çœ‹æ—¥å¿—
pm2 logs cloudflare-tunnel --lines 20
```

**æ­¥éª¤4ï¼šç­‰å¾…DNSä¼ æ’­**
```powershell
# ç­‰å¾…1-2åˆ†é’Ÿï¼Œç„¶åæµ‹è¯•
Start-Sleep -Seconds 120

# æµ‹è¯•è§£æ
Resolve-DnsName tunnel-api.yoyo-vps.your-domain.com

# æµ‹è¯•è®¿é—®
curl https://tunnel-api.yoyo-vps.your-domain.com/health
```

### 0.5.4 éªŒè¯æµ‹è¯•

**æµ‹è¯•æ¸…å•**ï¼š

```powershell
# æµ‹è¯•1: DNSè§£æ
$dns1 = Resolve-DnsName tunnel-api.yoyo-vps.your-domain.com
$dns2 = Resolve-DnsName tunnel-hls.yoyo-vps.your-domain.com
$dns3 = Resolve-DnsName tunnel-health.yoyo-vps.your-domain.com

Write-Host "DNSè§£æç»“æœï¼š"
Write-Host "tunnel-api: $($dns1.NameHost)"
Write-Host "tunnel-hls: $($dns2.NameHost)"
Write-Host "tunnel-health: $($dns3.NameHost)"

# æµ‹è¯•2: HTTPSè¿æ¥
try {
    $r1 = Invoke-RestMethod -Uri "https://tunnel-api.yoyo-vps.your-domain.com/health" -TimeoutSec 5
    Write-Host "âœ… tunnel-api æ­£å¸¸"
} catch {
    Write-Host "âŒ tunnel-api å¤±è´¥: $($_.Exception.Message)"
}

try {
    $r2 = Invoke-RestMethod -Uri "https://tunnel-health.yoyo-vps.your-domain.com" -TimeoutSec 5
    Write-Host "âœ… tunnel-health æ­£å¸¸"
} catch {
    Write-Host "âŒ tunnel-health å¤±è´¥"
}

# æµ‹è¯•3: HLSæ–‡ä»¶è®¿é—®ï¼ˆéœ€è¦æœ‰æ´»è·ƒçš„æµï¼‰
# å…ˆå¯åŠ¨ä¸€ä¸ªæµ‹è¯•æµï¼Œç„¶åè®¿é—®
# https://tunnel-hls.yoyo-vps.your-domain.com/hls/stream_xxx/playlist.m3u8
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] DNSæ­£ç¡®è§£æåˆ° `*.cfargotunnel.com`
- [ ] `tunnel-api` è¿”å›200çŠ¶æ€
- [ ] `tunnel-health` è¿”å›200çŠ¶æ€
- [ ] æ— SSLè¯ä¹¦é”™è¯¯
- [ ] å“åº”æ—¶é—´åˆç†ï¼ˆ<2ç§’ï¼‰

### 0.5.5 æ•…éšœæ’é™¤æŒ‡å—

**å¦‚æœDNSé…ç½®åä»ç„¶å¤±è´¥**ï¼š

```bash
# 1. æ£€æŸ¥cloudflaredæ—¥å¿—
pm2 logs cloudflare-tunnel --lines 50

# å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆï¼š
# - "ERR Authentication failed" â†’ é‡æ–°ç™»å½•: cloudflared tunnel login
# - "ERR Cannot locate tunnel" â†’ æ£€æŸ¥config.ymlä¸­çš„tunnel ID
# - "ERR Service unreachable" â†’ æ£€æŸ¥localhost:3000å’Œ8080æ˜¯å¦æ­£å¸¸
```

**å¦‚æœæœåŠ¡ç«¯å£æœªç›‘å¬**ï¼š

```bash
# æ£€æŸ¥ç«¯å£
netstat -tuln | grep -E '3000|8080'

# é‡å¯VPSæœåŠ¡
pm2 restart vps-transcoder-api
pm2 restart nginx  # å¦‚æœä½¿ç”¨nginx
```

### 0.5.6 è·³è¿‡æ­¤é˜¶æ®µçš„æ¡ä»¶

**å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå¯ä»¥è·³è¿‡**ï¼š
- âœ… `check-tunnel-status.ps1` æ˜¾ç¤ºéš§é“ç«¯ç‚¹æ­£å¸¸
- âœ… å½“å‰ä¸éœ€è¦éš§é“åŠŸèƒ½ï¼ˆåªä½¿ç”¨ç›´è¿å’Œä»£ç†ï¼‰
- âœ… å†³å®šåç»­å•ç‹¬ä¿®å¤éš§é“

**è·³è¿‡çš„å½±å“**ï¼š
- âš ï¸ éš§é“æ¨¡å¼æ— æ³•ä½¿ç”¨
- âš ï¸ é˜¶æ®µ4æµ‹è¯•æ—¶ï¼Œtunnelç›¸å…³çš„æµ‹è¯•ä¼šå¤±è´¥
- âœ… ä¸å½±å“directå’Œproxyæ¨¡å¼

### 0.5.7 æ›´æ–°çŠ¶æ€

âœ… éªŒè¯é€šè¿‡åï¼Œåœ¨è¿›åº¦è¡¨ä¸­æ ‡è®°ï¼š
- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
- éªŒè¯ç»“æœï¼šæ‰€æœ‰3ä¸ªéš§é“ç«¯ç‚¹æ­£å¸¸

æˆ–è€…æ ‡è®°ï¼š
- çŠ¶æ€ï¼šâ­ï¸ å·²è·³è¿‡
- åŸå› ï¼šä¸éœ€è¦éš§é“åŠŸèƒ½/åç»­å•ç‹¬ä¿®å¤

---

## ğŸ¯ é˜¶æ®µ1ï¼šåç«¯è·¯ç”±é€»è¾‘é‡å†™

**ç›®æ ‡**ï¼šå®ç°åŒç»´åº¦ç‹¬ç«‹åˆ¤æ–­ï¼Œæ”¯æŒåŒæ—¶å¯ç”¨éš§é“å’Œä»£ç†  
**å½±å“èŒƒå›´**ï¼štunnel-router.jsï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰  
**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š30åˆ†é’Ÿ

### 1.1 ä¿®æ”¹ - getOptimalEndpoints()

**æ–‡ä»¶**: `cloudflare-worker/src/utils/tunnel-router.js`  
**ä½ç½®**: ç¬¬7-74è¡Œï¼ˆå®Œå…¨é‡å†™ï¼‰

**åˆ é™¤**åŸæœ‰äº’æ–¥é€»è¾‘ï¼Œ**æ›¿æ¢ä¸º**ï¼š

```javascript
static async getOptimalEndpoints(env, request = null) {
  const country = request?.cf?.country;
  console.log('[TunnelRouter] ğŸ” åŒç»´åº¦è·¯ç”±å†³ç­–...', { country });
  
  // âœ… ç»´åº¦1: Workers â†’ VPS (å‰ç«¯è·¯å¾„)
  const tunnelEnabled = await TUNNEL_CONFIG.getTunnelEnabled(env);
  const frontendPath = tunnelEnabled ? 'tunnel' : 'direct';
  const frontendEndpoints = tunnelEnabled ? TUNNEL_CONFIG.TUNNEL_ENDPOINTS : TUNNEL_CONFIG.DIRECT_ENDPOINTS;
  
  console.log(`[TunnelRouter] ğŸ“¡ å‰ç«¯è·¯å¾„: ${frontendPath}`);
  
  // âœ… ç»´åº¦2: VPS â†’ RTMPæº (åç«¯è·¯å¾„) - ç‹¬ç«‹åˆ¤æ–­
  let backendPath = 'direct';
  let vpsProxyName = null;
  
  try {
    const res = await fetch(`${env.VPS_API_URL}/api/proxy/status`, {
      headers: { 'X-API-Key': env.VPS_API_KEY },
      signal: AbortSignal.timeout(3000)
    });
    
    if (res.ok) {
      const data = await res.json();
      if (data.data?.connectionStatus === 'connected') {
        backendPath = 'proxy';
        vpsProxyName = data.data.currentProxy?.name || 'unknown';
        console.log(`[TunnelRouter] ğŸ”— åç«¯è·¯å¾„: proxy (${vpsProxyName})`);
      }
    }
  } catch (e) {
    console.warn('[TunnelRouter] VPSä»£ç†æŸ¥è¯¢å¤±è´¥:', e.message);
  }
  
  if (backendPath === 'direct') {
    console.log('[TunnelRouter] ğŸ“¡ åç«¯è·¯å¾„: direct');
  }
  
  const routeType = `${frontendPath}+${backendPath}`;
  console.log(`[TunnelRouter] âœ… æœ€ç»ˆè·¯ç”±: ${routeType}`);
  
  return {
    type: routeType,
    frontendPath: { mode: frontendPath, endpoints: frontendEndpoints },
    backendPath: { mode: backendPath, proxyName: vpsProxyName },
    endpoints: frontendEndpoints,  // å‘åå…¼å®¹
    reason: this._buildRouteReason(frontendPath, backendPath, vpsProxyName, country)
  };
}

static _buildRouteReason(frontendPath, backendPath, vpsProxyName, country) {
  const r = [];
  r.push(frontendPath === 'tunnel' ? 'Workersé€šè¿‡Tunnelè®¿é—®VPS' : 'Workersç›´è¿VPS');
  r.push(backendPath === 'proxy' ? `VPSé€šè¿‡${vpsProxyName}ä»£ç†è·RTMPæµ` : 'VPSç›´è¿RTMPæº');
  if (country) r.push(`ä½ç½®: ${country}`);
  return r.join(' | ');
}
```

### 1.2 ä¿®æ”¹ - buildVPSUrl()

**æ–‡ä»¶**: `cloudflare-worker/src/utils/tunnel-router.js`  
**ä½ç½®**: ç¬¬81è¡Œ

**ä¿®æ”¹**ï¼š
```javascript
// åŸ: const baseUrl = routing.endpoints[service];
// æ”¹ä¸º:
const baseUrl = routing.frontendPath.endpoints[service];
```

### 1.3 éƒ¨ç½²

```bash
cd cloudflare-worker
npx wrangler deploy --env production
```

### 1.4 éªŒè¯æµ‹è¯•

**æµ‹è¯•æ–¹æ³•**ï¼šæ£€æŸ¥å“åº”å¤´

```powershell
# æµ‹è¯•APIè¯·æ±‚
$r = Invoke-WebRequest -Uri "https://yoyoapi.your-domain.com/api/streams" -Headers @{"Authorization"="Bearer YOUR_TOKEN"}
$r.Headers['X-Route-Type']  # åº”è¯¥æ˜¯ç±»ä¼¼ "tunnel+direct" æˆ– "direct+proxy"
```

**éªŒè¯æ¸…å•**ï¼š
- [ ] å“åº”å¤´åŒ…å« `X-Route-Type`ï¼ˆæ ¼å¼ï¼šfrontend+backendï¼‰
- [ ] åŒæ—¶å¯ç”¨éš§é“å’Œä»£ç†æ—¶ï¼Œè¿”å› `tunnel+proxy`
- [ ] è§†é¢‘ä»å¯æ­£å¸¸æ’­æ”¾
- [ ] æ— JavaScripté”™è¯¯

**å¦‚æœéªŒè¯å¤±è´¥**ï¼š
```bash
cp cloudflare-worker/src/utils/tunnel-router.js.backup cloudflare-worker/src/utils/tunnel-router.js
cd cloudflare-worker && npx wrangler deploy --env production
```

### 1.5 æ›´æ–°çŠ¶æ€

å®Œæˆåæ›´æ–°è¿›åº¦è¡¨ã€‚

---

## ğŸ¯ é˜¶æ®µ2ï¼šåç«¯URLå’Œå“åº”å¤´

**ç›®æ ‡**ï¼šä¿®å¤URLåŒ…è£…ï¼Œæ·»åŠ åŒç»´åº¦å“åº”å¤´  
**å½±å“èŒƒå›´**ï¼šstreams.jsï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰  
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­  
**é¢„è®¡æ—¶é—´**ï¼š25åˆ†é’Ÿ

### 2.1 ä¿®æ”¹ - wrapHlsUrlForCurrentMode()

**æ–‡ä»¶**: `cloudflare-worker/src/handlers/streams.js`  
**ä½ç½®**: ç¬¬255-285è¡Œ

**åˆ é™¤** `case 'proxy'` åˆ†æ”¯ï¼Œ**åªä¿ç•™**å‰ç«¯è·¯å¾„åˆ¤æ–­ï¼š

```javascript
function wrapHlsUrlForCurrentMode(baseHlsUrl, routingInfo, env, userToken) {
  if (!baseHlsUrl) throw new Error('Base HLS URL is required');
  
  const token = userToken || env.VIDEO_TOKEN || 'default-token';
  
  let hlsPath;
  if (baseHlsUrl.startsWith('http')) {
    hlsPath = new URL(baseHlsUrl).pathname;
  } else {
    hlsPath = baseHlsUrl.startsWith('/') ? baseHlsUrl : `/${baseHlsUrl}`;
  }
  
  // âœ… åªæ ¹æ®å‰ç«¯è·¯å¾„å†³å®šURL
  const frontendPath = routingInfo.frontendPath?.mode || 'direct';
  
  switch(frontendPath) {
    case 'tunnel':
      return `https://tunnel-hls.yoyo-vps.your-domain.com${hlsPath}?token=${token}`;
    case 'direct':
      return `https://yoyoapi.your-domain.com${hlsPath}?token=${token}`;
    default:
      console.warn(`æœªçŸ¥å‰ç«¯è·¯å¾„ ${frontendPath}`);
      return `https://yoyoapi.your-domain.com${hlsPath}?token=${token}`;
  }
}
```

### 2.2 ä¿®æ”¹ - æ·»åŠ å“åº”å¤´ï¼ˆ3å¤„ï¼‰

åœ¨ `startWatching`, `stopWatching`, `getSystemStatus` ç­‰æ–¹æ³•ä¸­æ·»åŠ åŒç»´åº¦å“åº”å¤´ï¼š

```javascript
headers: {
  'Content-Type': 'application/json',
  // æ–°å¢åŒç»´åº¦å“åº”å¤´
  'X-Route-Type': routing.type,
  'X-Frontend-Path': routing.frontendPath.mode,
  'X-Backend-Path': routing.backendPath.mode,
  'X-VPS-Proxy-Name': routing.backendPath.proxyName || 'none',
  'X-Tunnel-Enabled': routing.frontendPath.mode === 'tunnel' ? 'true' : 'false',
  'X-VPS-Proxy-Enabled': routing.backendPath.mode === 'proxy' ? 'true' : 'false',
  // ... å…¶ä»–ç°æœ‰å“åº”å¤´
}
```

### 2.3 éƒ¨ç½²

```bash
cd cloudflare-worker
npx wrangler deploy --env production
```

### 2.4 éªŒè¯æµ‹è¯•

**æµ‹è¯•4ç§ç»„åˆ**ï¼š

```powershell
# æµ‹è¯•tunnel+proxy
$r = Invoke-WebRequest -Uri "https://yoyoapi.your-domain.com/api/simple-stream/start-watching" `
  -Method POST -Body '{"channelId":"ID"}' -ContentType "application/json" `
  -Headers @{"Authorization"="Bearer YOUR_TOKEN"}

$r.Headers['X-Route-Type']        # tunnel+proxy
$r.Headers['X-Frontend-Path']     # tunnel
$r.Headers['X-Backend-Path']      # proxy
$r.Headers['X-VPS-Proxy-Name']    # jp (æˆ–ä½ çš„ä»£ç†å)
```

**éªŒè¯æ¸…å•**ï¼š
- [ ] å“åº”å¤´åŒ…å«æ‰€æœ‰6ä¸ªæ–°å­—æ®µ
- [ ] HLS URL ä¸åŒ…å« `/tunnel-proxy` è·¯å¾„
- [ ] tunnel è¿”å› `tunnel-hls.yoyo-vps.your-domain.com`
- [ ] direct è¿”å› `yoyoapi.your-domain.com`

### 2.5 æ›´æ–°çŠ¶æ€

---

## ğŸ¯ é˜¶æ®µ3ï¼šå‰ç«¯æ˜¾ç¤ºé€»è¾‘

**ç›®æ ‡**ï¼šæ˜¾ç¤ºåŒæ ‡ç­¾[å‰ç«¯: xxx] [åç«¯: xxx]  
**å½±å“èŒƒå›´**ï¼šVideoPlayer.vueï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½ï¼ˆåªå½±å“UIï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š30åˆ†é’Ÿ

### 3.1 ä¿®æ”¹ - æ¨¡æ¿éƒ¨åˆ†

**æ–‡ä»¶**: `frontend/src/components/VideoPlayer.vue`  
**ä½ç½®**: ç¬¬86-94è¡Œ

**æ›¿æ¢ä¸º**åŒæ ‡ç­¾æ˜¾ç¤ºï¼š

```vue
<!-- å‰ç«¯è·¯å¾„ -->
<div class="info-item" v-if="frontendPath">
  <span class="label">å‰ç«¯:</span>
  <el-tag :type="frontendPathType" size="small">
    <el-icon style="margin-right: 4px;"><component :is="frontendPathIcon" /></el-icon>
    {{ frontendPathText }}
  </el-tag>
</div>

<!-- åç«¯è·¯å¾„ -->
<div class="info-item" v-if="backendPath">
  <span class="label">åç«¯:</span>
  <el-tag :type="backendPathType" size="small">
    <el-icon style="margin-right: 4px;"><component :is="backendPathIcon" /></el-icon>
    {{ backendPathText }}
  </el-tag>
</div>
```

### 3.2 ä¿®æ”¹ - Scriptéƒ¨åˆ†

**ä½ç½®1**: ç¬¬133è¡Œï¼Œæ·»åŠ å˜é‡

```javascript
// åˆ é™¤: const connectionMode = ref('')
// æ·»åŠ :
const frontendPath = ref('')
const backendPath = ref('')
const vpsProxyName = ref('')
```

**ä½ç½®2**: ç¬¬158-193è¡Œï¼Œæ›¿æ¢computed

```javascript
const frontendPathType = computed(() => frontendPath.value === 'tunnel' ? 'success' : 'info')
const frontendPathIcon = computed(() => frontendPath.value === 'tunnel' ? Connection : Link)
const frontendPathText = computed(() => frontendPath.value === 'tunnel' ? 'éš§é“ä¼˜åŒ–' : 'ç›´è¿')

const backendPathType = computed(() => backendPath.value === 'proxy' ? 'success' : 'info')
const backendPathIcon = computed(() => backendPath.value === 'proxy' ? Connection : Link)
const backendPathText = computed(() => {
  if (backendPath.value === 'proxy') {
    return vpsProxyName.value ? `ä»£ç†(${vpsProxyName.value})` : 'ä»£ç†'
  }
  return 'ç›´è¿'
})
```

**ä½ç½®3**: æ›´æ–°å“åº”å¤´è¯»å–ï¼ˆ2å¤„ï¼‰

```javascript
// è¯»å–æ–°çš„åŒç»´åº¦å“åº”å¤´
frontendPath.value = response.headers.get('x-frontend-path') || 'unknown'
backendPath.value = response.headers.get('x-backend-path') || 'unknown'
const proxyName = response.headers.get('x-vps-proxy-name')
if (proxyName && proxyName !== 'none') {
  vpsProxyName.value = proxyName
}
```

**ä½ç½®4**: æ›´æ–°URLæ¨æ–­å‡½æ•°

```javascript
const detectConnectionModeFromUrl = (url) => {
  if (!url) return { frontend: 'unknown', backend: 'unknown' }
  
  let frontend = 'direct'
  if (url.includes('tunnel-hls.yoyo-vps.your-domain.com')) {
    frontend = 'tunnel'
  }
  
  return { frontend, backend: 'unknown' }
}
```

### 3.3 éƒ¨ç½²

```bash
git add frontend/src/components/VideoPlayer.vue
git commit -m "feat: å‰ç«¯æ”¯æŒåŒç»´åº¦è·¯ç”±æ˜¾ç¤º"
git push origin master
# ç­‰å¾…Cloudflare Pageséƒ¨ç½²
```

### 3.4 éªŒè¯æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€è§†é¢‘æ’­æ”¾é¡µé¢
2. æ£€æŸ¥æ˜¾ç¤ºæ•ˆæœ

**éªŒè¯æ¸…å•**ï¼š
- [ ] æ˜¾ç¤ºä¸¤ä¸ªç‹¬ç«‹æ ‡ç­¾ï¼š[å‰ç«¯: xxx] [åç«¯: xxx]
- [ ] tunnel+proxy æ˜¾ç¤ºï¼š[å‰ç«¯: éš§é“ä¼˜åŒ–] [åç«¯: ä»£ç†(jp)]
- [ ] ä»£ç†åç§°æ­£ç¡®æ˜¾ç¤º
- [ ] çŠ¶æ€é¢œè‰²æ­£ç¡®ï¼ˆsuccess=ç»¿è‰², info=è“è‰²ï¼‰

### 3.5 æ›´æ–°çŠ¶æ€

---

## ğŸ¯ é˜¶æ®µ4ï¼šå®Œæ•´é›†æˆæµ‹è¯•

**ç›®æ ‡**ï¼šæµ‹è¯•æ‰€æœ‰4ç§è·¯å¾„ç»„åˆ  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½ï¼ˆåªæ˜¯éªŒè¯ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š20åˆ†é’Ÿ

### 4.1 æµ‹è¯•çŸ©é˜µ

| æµ‹è¯• | éš§é“ | ä»£ç† | é¢„æœŸX-Route-Type | é¢„æœŸå‰ç«¯æ˜¾ç¤º |
|------|------|------|-----------------|-------------|
| 1 | âœ… | âœ… | tunnel+proxy | [å‰ç«¯: éš§é“ä¼˜åŒ–] [åç«¯: ä»£ç†(jp)] |
| 2 | âœ… | âŒ | tunnel+direct | [å‰ç«¯: éš§é“ä¼˜åŒ–] [åç«¯: ç›´è¿] |
| 3 | âŒ | âœ… | direct+proxy | [å‰ç«¯: ç›´è¿] [åç«¯: ä»£ç†(jp)] |
| 4 | âŒ | âŒ | direct+direct | [å‰ç«¯: ç›´è¿] [åç«¯: ç›´è¿] |

### 4.2 æ‰§è¡Œæµ‹è¯•

**æµ‹è¯•1ï¼štunnel+proxy**ï¼ˆæœ€é‡è¦ï¼‰
1. ç®¡ç†åå°å¯ç”¨éš§é“
2. ç®¡ç†åå°è¿æ¥ä»£ç†
3. æ’­æ”¾è§†é¢‘ï¼ŒéªŒè¯å“åº”å¤´å’Œå‰ç«¯æ˜¾ç¤º

**ä¾æ¬¡å®Œæˆå…¶ä»–3ä¸ªæµ‹è¯•**

### 4.3 æœ€ç»ˆéªŒæ”¶

**æ‰€æœ‰åŠŸèƒ½éªŒè¯**ï¼š
- [ ] è§†é¢‘æ’­æ”¾æ­£å¸¸
- [ ] é¢‘é“åˆ‡æ¢æ­£å¸¸
- [ ] éš§é“å¼€å…³ç«‹å³ç”Ÿæ•ˆ
- [ ] 4ç§ç»„åˆéƒ½èƒ½æ­£å¸¸å·¥ä½œ
- [ ] å‰ç«¯æ˜¾ç¤ºæ¸…æ™°å‡†ç¡®

### 4.4 æ›´æ–°çŠ¶æ€

âœ… å…¨éƒ¨é˜¶æ®µå®Œæˆï¼

---

## ğŸ“¦ é˜¶æ®µ5: Workersä»£ç†SSLä¿®å¤ï¼ˆæ–°å¢ï¼‰

### 5.1 é—®é¢˜èƒŒæ™¯

**å‘ç°çš„é—®é¢˜**ï¼š
- éš§é“æ¨¡å¼å¼€å¯åï¼Œæµè§ˆå™¨ç›´æ¥è®¿é—® `tunnel-hls.yoyo-vps.your-domain.com` 
- SSLæ¡æ‰‹å¤±è´¥ï¼š`ERR_SSL_VERSION_OR_CIPHER_MISMATCH`
- å¯¼è‡´éš§é“æ¨¡å¼ä¸‹è§†é¢‘æ— æ³•æ’­æ”¾

**æ ¹æœ¬åŸå› **ï¼š
- Cloudflare Tunnel SSLé…ç½®é—®é¢˜
- ä¿®æ”¹å…¨å±€SSLè®¾ç½®ä¼šå½±å“æ‰€æœ‰å­åŸŸåæœåŠ¡

### 5.2 è§£å†³æ–¹æ¡ˆï¼šWorkersä»£ç†

**æŠ€æœ¯æ¶æ„**ï¼š
```
æµè§ˆå™¨ â†’ yoyoapi.your-domain.com/tunnel-proxy/hls/*
         (æ­£å¸¸SSL) âœ…
           â†“
        Workerså†…éƒ¨ä»£ç†
           â†“
      tunnel-hls.yoyo-vps.your-domain.com/hls/*
      (Cloudflareå†…éƒ¨è¿æ¥ï¼Œç»•è¿‡æµè§ˆå™¨SSLéªŒè¯) âœ…
```

### 5.3 ä»£ç ä¿®æ”¹

#### ä¿®æ”¹1: streams.js - URLåŒ…è£…é€»è¾‘
```javascript
// cloudflare-worker/src/handlers/streams.js (ç¬¬277è¡Œ)
case 'tunnel':
  // âœ… ä½¿ç”¨Workersä»£ç†è·¯å¾„ï¼Œç»•è¿‡æµè§ˆå™¨SSLéªŒè¯é—®é¢˜
  return `https://yoyoapi.your-domain.com/tunnel-proxy${hlsPath}?token=${token}`;
```

#### ä¿®æ”¹2: index.js - Workersä»£ç†å¤„ç†å™¨
```javascript
// cloudflare-worker/src/index.js (ç¬¬346-413è¡Œ)
router.get('/tunnel-proxy/hls/:streamId/:file', async (req, env, ctx) => {
  const tunnelUrl = `https://tunnel-hls.yoyo-vps.your-domain.com/hls/${streamId}/${file}${queryString}`;
  
  // Workerså†…éƒ¨ä»£ç†ï¼ˆCloudflareå†…éƒ¨ï¼Œæ— æµè§ˆå™¨SSLé—®é¢˜ï¼‰
  const response = await fetch(tunnelUrl, {
    headers: {
      'User-Agent': 'YOYO-Workers-Proxy/1.0',
      // ...
    }
  });
  
  // æ·»åŠ ä»£ç†æ ‡è¯†
  headers.set('X-Proxied-By', 'Workers-Tunnel-Proxy');
  
  return new Response(response.body, {
    status: response.status,
    headers: headers
  });
});
```

### 5.4 éƒ¨ç½²éªŒè¯

**éƒ¨ç½²å‘½ä»¤**ï¼š
```bash
# Workerséƒ¨ç½²
cd cloudflare-worker
wrangler deploy --env production

# Gitæäº¤
git add .
git commit -m "feat: å®æ–½Workersä»£ç†æ–¹æ¡ˆè§£å†³éš§é“SSLé—®é¢˜"
git push origin master
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… æ‰€æœ‰HLSè¯·æ±‚é€šè¿‡ `/tunnel-proxy/hls/*` è·¯å¾„
- âœ… å“åº”å¤´åŒ…å« `X-Proxied-By: Workers-Tunnel-Proxy`
- âœ… playlist.m3u8 å’Œ .ts åˆ†ç‰‡å…¨éƒ¨ 200 æˆåŠŸ
- âœ… è§†é¢‘æ­£å¸¸æ’­æ”¾ï¼ŒçŠ¶æ€æ˜¾ç¤º"éš§é“ä¼˜åŒ–"
- âœ… å‰ç«¯æ˜¾ç¤ºï¼š[å‰ç«¯: éš§é“ä¼˜åŒ–] [åç«¯: ç›´è¿]

### 5.5 æŠ€æœ¯ä¼˜åŠ¿

1. **ä¸å½±å“å…¶ä»–æœåŠ¡** - ä¸éœ€è¦ä¿®æ”¹Cloudflare SSLé…ç½®
2. **å¿«é€Ÿå®æ–½** - åªéœ€ä¿®æ”¹Workersä»£ç ï¼Œ10åˆ†é’Ÿå®Œæˆ
3. **å†…ç½®æ•…éšœè½¬ç§»** - Workersä»£ç†å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°ç›´è¿
4. **é€æ˜ä»£ç†** - å¯¹å‰ç«¯å®Œå…¨é€æ˜ï¼Œä¿æŒAPIä¸€è‡´æ€§

### 5.6 æ€§èƒ½å½±å“

**ç†è®ºå»¶è¿Ÿ**ï¼š
- å¢åŠ ä¸€å±‚Workersä»£ç†ï¼š~10-50ms
- Cloudflareå†…éƒ¨ç½‘ç»œï¼Œå»¶è¿Ÿæä½

**å®é™…æµ‹è¯•**ï¼š
- HLSè¯·æ±‚å»¶è¿Ÿï¼š<100ms
- è§†é¢‘æ’­æ”¾æµç•…ï¼Œæ— æ˜æ˜¾å½±å“

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœä»»ä½•é˜¶æ®µå¤±è´¥ï¼š

```bash
# å›æ»šåˆ°å¤‡ä»½
cp cloudflare-worker/src/utils/tunnel-router.js.backup cloudflare-worker/src/utils/tunnel-router.js
cp cloudflare-worker/src/handlers/streams.js.backup cloudflare-worker/src/handlers/streams.js
cp cloudflare-worker/src/handlers/deployment.js.backup cloudflare-worker/src/handlers/deployment.js
cp frontend/src/components/VideoPlayer.vue.backup frontend/src/components/VideoPlayer.vue
cp frontend/src/components/admin/TunnelConfig.vue.backup frontend/src/components/admin/TunnelConfig.vue

# é‡æ–°éƒ¨ç½²
cd cloudflare-worker && npx wrangler deploy --env production
cd .. && git reset --hard HEAD~N  # N=å›é€€çš„æäº¤æ•°
```

---

## ğŸ“ ä¿®æ”¹æ€»ç»“

**ä¿®æ”¹çš„æ–‡ä»¶**: 5ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼Œçº¦200è¡Œä»£ç 

**å…³é”®æ”¹è¿›**ï¼š
1. âœ… éš§é“å¼€å…³ç«‹å³ç”Ÿæ•ˆï¼ˆæ¸…é™¤ç¼“å­˜ï¼‰
2. âœ… æ”¯æŒåŒç»´åº¦ç‹¬ç«‹è·¯ç”±ï¼ˆ4ç§ç»„åˆï¼‰
3. âœ… å‰ç«¯æ¸…æ™°æ˜¾ç¤ºä¸¤ä¸ªç»´åº¦çŠ¶æ€
4. âœ… åˆ é™¤æ‰€æœ‰åºŸå¼ƒé€»è¾‘ï¼ˆ/tunnel-proxyè·¯å¾„ç­‰ï¼‰

**å®Œæˆåæ•ˆæœ**ï¼š
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡
- ç³»ç»Ÿæ¶æ„æ›´æ¸…æ™°
- å¯ä»¥äº«å—åŒé‡ä¼˜åŒ–ï¼ˆtunnel+proxyï¼‰

---

**æ–‡æ¡£å®Œæˆ** | ä¸¥æ ¼æŒ‰é˜¶æ®µæ‰§è¡Œï¼Œæ¯é˜¶æ®µéªŒè¯é€šè¿‡åæ›´æ–°è¿›åº¦è¡¨
