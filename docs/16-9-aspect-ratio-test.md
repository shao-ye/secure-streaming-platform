# 16:9视频比例转换测试文档

## 📋 功能说明

**部署时间**: 2025-11-05 22:42  
**Git提交**: efc7066  
**修改内容**: 添加FFmpeg视频滤镜，保持原始高度，调整宽度到16:9比例

---

## 🎯 转换规则

### FFmpeg滤镜参数
```bash
-vf scale=ih*16/9:ih
```

### 转换效果

| 输入分辨率 | 输入比例 | 输出分辨率 | 输出比例 | 变化说明 |
|-----------|---------|-----------|---------|---------|
| 704x576 | 4:3 | 1024x576 | 16:9 | 宽度拉伸45% |
| 640x480 | 4:3 | 853x480 | 16:9 | 宽度拉伸33% |
| 1280x720 | 16:9 | 1280x720 | 16:9 | 无变化 |
| 1920x1080 | 16:9 | 1920x1080 | 16:9 | 无变化 |

---

## ✅ 验证方法

### 方法1：通过浏览器观看

1. **访问平台**: https://yoyo.your-domain.com/
2. **选择任意频道开始观看**
3. **观察画面比例**:
   - 画面应该填满播放器（16:9）
   - 如果原视频是4:3，会看到横向拉伸效果
   - 如果原视频已经是16:9，无明显变化

### 方法2：检查FFmpeg命令

```bash
# SSH到VPS
ssh root@<VPS_IP>

# 查看FFmpeg进程命令（等待有人观看时）
ps aux | grep ffmpeg

# 应该能看到类似这样的命令：
# ffmpeg -i rtmp://... -c:v libx264 -preset ultrafast -an -vf scale=ih*16/9:ih -f hls ...
```

**关键点**: 检查是否包含 `-vf scale=ih*16/9:ih`

### 方法3：查看HLS流分辨率

```bash
# SSH到VPS
ssh root@<VPS_IP>

# 检查某个频道的HLS流（需要先有人观看）
ffprobe http://localhost:3000/hls/stream_xxx/playlist.m3u8 2>&1 | grep "Video:"

# 输出示例：
# Stream #0:0: Video: h264, yuv420p, 1024x576, 25 fps
# 检查分辨率是否符合16:9比例
```

### 方法4：检查录制文件分辨率

```bash
# SSH到VPS
ssh root@<VPS_IP>

# 查看录制文件（如果有录制）
cd /var/www/recordings
ls -la

# 检查某个录制文件的分辨率
ffprobe /var/www/recordings/stream_xxx/20251105/xxx.mp4 2>&1 | grep "Video:"

# 应该看到16:9的分辨率
```

---

## 📊 性能监控

### CPU使用率监控

```bash
# SSH到VPS
ssh root@<VPS_IP>

# 实时监控CPU
top

# 或使用htop（更友好）
htop

# 查看FFmpeg进程
ps aux | grep ffmpeg
```

**预期CPU变化**:
- 只观看：增加3-5%
- 观看+录制：增加15-25%

### 服务日志监控

```bash
# 查看PM2日志
pm2 logs vps-transcoder-api

# 查看最近的FFmpeg启动命令
pm2 logs vps-transcoder-api | grep "Starting FFmpeg"

# 应该能看到包含 -vf scale=ih*16/9:ih 的命令
```

---

## 🧪 测试计划

### 第一阶段：小范围测试 ✅ 推荐

1. **选择1-2个频道作为试点**
   - 选择不同原始比例的频道
   - 例如：1个4:3频道 + 1个16:9频道

2. **观看测试**
   - 观察画面是否拉伸到16:9
   - 检查是否有明显变形
   - 确认用户体验是否满意

3. **性能测试**
   - 监控CPU使用率
   - 确认不超过90%
   - 观察是否有卡顿

4. **录制测试**（如果启用录制）
   - 确认录制文件也是16:9
   - 检查文件是否可正常播放
   - 验证文件大小是否正常

### 第二阶段：全量部署 ⏳ 待定

等待第一阶段测试结果：
- ✅ 画面效果满意
- ✅ 性能可接受
- ✅ 无明显问题

则可以让所有频道自动应用16:9转换。

---

## ⚠️ 注意事项

### 1. 性能影响

**观看场景（无录制）**:
```
修改前：60-70% CPU
修改后：65-75% CPU
增加：+5%
```

**录制场景**:
```
修改前：70-80% CPU（MP4使用copy模式）
修改后：85-95% CPU（MP4需要重新编码）
增加：+15-25%
```

⚠️ **重要**：如果同时有多个频道在录制，CPU可能接近100%

### 2. 影响范围

本次修改影响：
- ✅ **所有HLS观看流**：自动转为16:9
- ✅ **所有MP4录制文件**：自动转为16:9
- ✅ **预加载功能**：自动应用16:9
- ✅ **新用户观看**：立即生效
- ✅ **现有用户**：刷新页面后生效

### 3. 回退方案

如果测试不满意，可以快速回退：

**方法1：Git回退（推荐）**
```bash
# 本地回退
cd D:\项目文件\yoyo-kindergarten\code\secure-streaming-platform
git revert efc7066
git push origin master

# VPS部署
ssh root@<VPS_IP>
cd /tmp/github/secure-streaming-platform/vps-server/scripts
./vps-simple-deploy.sh
```

**方法2：手动修改VPS文件**
```bash
# SSH到VPS
ssh root@<VPS_IP>

# 编辑文件
vi /opt/yoyo-transcoder/src/services/SimpleStreamManager.js

# 删除以下2行：
# '-vf', 'scale=ih*16/9:ih',

# 将录制部分改回：
# '-c:v', 'copy',

# 重启服务
pm2 restart vps-transcoder-api
```

---

## 🔍 常见问题

### Q: 为什么有些频道看起来变形了？
A: 原视频比例不是16:9（如4:3），拉伸后会有横向变形。这是预期行为。

### Q: 可以只转换观看流，不转换录制文件吗？
A: 可以。需要修改代码，在录制输出部分去掉滤镜。但这样会导致观看和录制的分辨率不一致。

### Q: CPU占用太高怎么办？
A: 
1. 减少同时录制的频道数
2. 升级VPS配置（增加CPU核心）
3. 回退到不使用16:9转换

### Q: 已经在观看的用户需要刷新吗？
A: 是的。已经在观看的用户需要刷新页面，新的FFmpeg进程才会应用16:9转换。

### Q: 录制的历史文件会改变吗？
A: 不会。只有新录制的文件才会是16:9。历史文件保持原样。

---

## 📝 测试记录

### 测试环境
- **VPS**: <VPS_IP> (RackNerd 2核4GB)
- **部署时间**: 2025-11-05 22:42
- **Git版本**: efc7066

### 待测试项目

- [ ] **画面效果测试**
  - [ ] 4:3源视频拉伸效果
  - [ ] 16:9源视频无变化
  - [ ] 画面清晰度
  - [ ] 用户接受度

- [ ] **性能测试**
  - [ ] 单频道观看CPU占用
  - [ ] 多频道观看CPU占用
  - [ ] 观看+录制CPU占用
  - [ ] 是否有卡顿

- [ ] **录制测试**
  - [ ] 录制文件分辨率正确
  - [ ] 录制文件可正常播放
  - [ ] 录制文件大小正常

- [ ] **兼容性测试**
  - [ ] 预加载功能正常
  - [ ] 心跳保活正常
  - [ ] 自动清理正常

### 测试结果

| 测试项 | 结果 | 说明 | 测试时间 |
|--------|------|------|---------|
| - | - | - | - |

---

## 🚀 后续优化方向

如果16:9转换效果满意，后续可以考虑：

1. **配置化**：添加开关，支持启用/禁用16:9转换
2. **分辨率选择**：支持720p/1080p等固定分辨率
3. **智能模式**：根据源视频比例自动选择转换策略
4. **性能优化**：调整FFmpeg preset参数

---

**文档版本**: v1.0  
**最后更新**: 2025-11-05  
**维护人员**: 系统管理员
